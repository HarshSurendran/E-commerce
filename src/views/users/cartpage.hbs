<!-- Shop Cart Section Begin -->
    <section class="shop-cart spad">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="shop__cart__table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#if cart}}
                                {{#each cart}}
                                <tr>
                                    <td class="cart__product__item">
                                        <img width="90px" height="90px" src="{{this.product.images.[0]}}" alt="">
                                        <div class="cart__product__item__title">
                                            <h6>{{this.product.name.name}}</h6>
                                            <div class="rating">
                                                <i class="fa fa-star"></i>
                                                <i class="fa fa-star"></i>
                                                <i class="fa fa-star"></i>
                                                <i class="fa fa-star"></i>
                                                <i class="fa fa-star"></i>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="cart_price">{{this.product.price}}</td>
                                    <td style="width: 7rem;" class="cart__quantity ">
                                        {{!-- <div class="pro-qty quantity123">
                                            <input type="number" class="quantity-input" value="{{this.quantity}}">
                                            <span class="inc qtybtn">+</span>
                                        </div> --}}
                                        
                                        <div class="input-group quantity">
                                            <button class="btn btn-dark  dec qtybtn" type="button">-</button>
                                            <input type="text" style="max-width: 3;" class="form-control quantity-input border-0 "  data-id="{{this._id}}" value="{{this.quantity}}" min="1">
                                            <button class="btn btn-dark  inc qtybtn" type="button">+</button>
                                        </div>

                                    </td>
                                    <td id="carttotal{{@index}}" class="cart_total">{{multiply this.quantity this.product.price}}</td>
                                    <a id="deleteCartBut" ><td class="cart__close deleteCartBut" data-id="{{this._id}}"><span class="icon_close"></span></td>
                                </tr></a>
                                {{/each}}
                                {{else}}
                                <p class="text-center ">Your cart is empty please add items to the cart.</p>
                                {{/if}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-6 col-md-6 col-sm-6">
                    <div class="cart__btn">
                        <a href="/api/v1/users/listproducts">Continue Shopping</a>
                    </div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-6">
                    <div class="cart__btn update__btn">
                        <a href="#"><span class="icon_loading"></span> Update cart</a>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-6">
                    <div class="discount__content">
                        <h6>Discount codes</h6>
                        <form action="#">
                            <input type="text" placeholder="Enter your coupon code">
                            <button type="submit" class="site-btn">Apply</button>
                        </form>
                    </div>
                </div>
                <div class="col-lg-4 offset-lg-2">
                    <div class="cart__total__procced">
                        <h6>Cart total</h6>
                        <ul>
                            <li>Subtotal <span id="subtotal">{{total}}</span></li>
                            <li id="total">Total <span id="grandtotal">{{total}}</span></li>
                        </ul>
                        <a href="#" class="primary-btn">Proceed to checkout</a>
                    </div>
                </div>
            </div>
        </div>
    </section>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<script>

    document.addEventListener("DOMContentLoaded",()=>{

        const deleteButton = document.querySelectorAll(".deleteCartBut");
        deleteButton.forEach((element)=>{
            element.addEventListener("click", ()=>{
                const id = element.getAttribute("data-id");
                console.log("This  is cart id", id)
                    const confirmation = window.confirm("Are you sure you want to delete this item from the cart?");


                if(confirmation){
                    fetch("/api/v1/users/cart", {
                        method: "DELETE",
                        headers: {
                            "content-type": "application/json"
                        },
                        body : JSON.stringify({
                            id
                        })
                    }).then( (res)=>{
                        if(!res.ok){
                            console.log("somethign wronf")
                            return 
                        }
                        
                        location.reload();
                    })
                }
            });
        });

        /*const quantity = document.querySelectorAll(".quantity123");
        quantity.forEach((element)=>{
            element.addEventListener("click",()=>{
                const value = document.querySelectorAll (".quantity-input").value 
                console.log("This is quantity div and the input value is :", value);
            })
        })*/

        document.body.addEventListener("input", (event) => {
            const target = event.target;

            // Check if the input field is the quantity-input class
            if (target.classList.contains("quantity-input")) {
                console.log("Input changed");
                // Add your logic here to handle the input change event
            }
        });

        document.body.addEventListener("change", (event) => {
            const target = event.target;

            // Check if the input field is the quantity-input class
            if (target.classList.contains("quantity-input")) {
                console.log("Value changed");
                // Add your logic here to handle the value change event
            }
        });
    })


    function grandTotal(){
        let totalPrice=0;
        const cartTotal = document.querySelectorAll(".cart_total");
        console.log("this isc carttotal", cartTotal);
        cartTotal.forEach((price)=>{
            totalPrice = totalPrice+ parseInt(price.textContent);
        })
        console.log("this is totalpricce", totalPrice);
        const subTotal = document.getElementById("subtotal");
        subTotal.textContent = totalPrice;
        const grandTotal = document.getElementById("grandtotal");
        grandTotal.textContent = totalPrice;
    }

    function updateTotal(qty, event){
        
        const priceelem = event.target.parentElement.parentElement.parentElement.querySelector(".cart_price");
        const totalpriceelem = event.target.parentElement.parentElement.parentElement.querySelector(".cart_total");    
        const price = parseInt(priceelem.textContent);
        totalprice = qty*price;
        totalpriceelem.textContent = totalprice;        
        grandTotal();
    }


    document.querySelectorAll('.qtybtn').forEach((btn) => {
        btn.addEventListener('click', (event) => {            
            const input = event.target.parentElement.querySelector('.quantity-input');
            const currentValue = parseInt(input.value);
            const increment = event.target.classList.contains('inc') ? 1 : -1;
            const id = input.getAttribute("data-id");
            
            if ((currentValue + increment >= 1) && (currentValue + increment <= 10)) {                
                let qty = currentValue + increment;
                //implement the stockleft calculation here
                

                fetch("/api/v1/users/cart",{
                    method : "PATCH",
                    headers: {
                        "content-type" : "application/json"
                    },
                    body: JSON.stringify({
                        id,
                        quantity : qty
                    })
                })
                .then(res=> res.json())
                .then((data)=>{
                    console.log(data)
                    if(!data.success){
                        return alert("couldnt add in cart")
                    }
                    input.value = qty;
                    updateTotal(qty, event); 
                })                
            }
        });
    });

</script>